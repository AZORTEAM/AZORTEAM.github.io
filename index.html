
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 5.0 Transitional//PT"><html>
<head>
    <title>SIMON</title>

    <script type="text/javascript">
        var start = function ()
		{
            var inc = document.getElementById('incomming');
            var wsImpl = window.WebSocket || window.MozWebSocket;
            var form = document.getElementById('sendForm');
            var input = document.getElementById('sendText');
	//=========================================================================================================		
		    var ws = new WebSocket('ws://localhost:8081');
            window.SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            let finalTranscript = '';
            let recognition = new window.SpeechRecognition();
        	recognition.lang = 'pt-BR';
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.continuous = false;
     //======================================================================================================== 
			
    recognition.onresult = (event) => 
	{
      let interimTranscript = '';
      for (let i = event.resultIndex, len = event.results.length; i < len; i++)
	  {
        let transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) 
		{
			 ws.send(transcript + ".");
             finalTranscript += transcript;
        } 
		 else 
		{
          interimTranscript += transcript;
		  ws.send(interimTranscript);   
        }

      }
	   //inc.innerHTML += '.. connection closed<br/>';
      // inc.innerHTML += finalTranscript + '<i style="color:#ddd;">' + interimTranscript + '</>' + '<br/>';
    }
    //recognition.start();
				
            inc.innerHTML += "TENTANDO CONECTAR AO SERVIDOR...<br/>";

            // create a new websocket and connect
            window.ws = new wsImpl('ws://localhost:2022/');

            // when data is comming from the server, this metod is called
            ws.onmessage = function (evt) 
			{
               // inc.innerHTML += evt.data + '<br/>';
				if (evt.data === 'reconhecimento de voz')
                {
				  
                     recognition.start();
                   
                  
                }
				
				if (evt.data === 'Pesquisa')
                {
                   recognition.continuous = true;
				   recognition.start();
                }
				
				if (evt.data === 'quit')
                {
                   window.close();
                }
				
				if (evt.data === 'stop')
                {
                 
				   recognition.stop();
				   
                }
            };

            // when the connection is established, this method is called
            ws.onopen = function () 
			{
                inc.innerHTML += 'CONEXÃO ESTABELECIDA.<br/>';
            };

            // when the connection is closed, this method is called
            ws.onclose = function () 
			{
                inc.innerHTML += 'CONEXÃO FECHADA.<br/>';
				window.location.reload();
				
            }
            
			form.addEventListener('submit', function(e)
			{
				e.preventDefault();
				var val = input.value;
				ws.send(val);
				input.value = "";
			});
				
			recognition.addEventListener('audioend', function()
			{ 
              ws.send("!");
			});
			
			recognition.addEventListener('audiostart', function()
			{ 
              ws.send("#");
			});
			
			recognition.addEventListener('nomatch', function() 
			{ 
				ws.send("Fala náo reconhecida");
            });
			
			recognition.addEventListener('error', function(event)
			{ 
               ws.send("Erro");
            });
            
        }
        window.onload = start;
    </script>
</head>
<body>
	<form id="sendForm">
		<input id="sendText" placeholder="Text to send" />
	</form>
    <pre id="incomming"></pre>
</body>
</html>
